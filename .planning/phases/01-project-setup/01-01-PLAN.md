---
phase: 01-project-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-workspace.yaml
  - .gitignore
  - flake.nix
  - apps/desktop/package.json
  - apps/desktop/index.html
  - apps/desktop/vite.config.ts
  - apps/desktop/tsconfig.json
  - apps/desktop/tsconfig.node.json
  - apps/desktop/src/main.tsx
  - apps/desktop/src/App.tsx
  - apps/desktop/src/index.css
  - apps/desktop/src-tauri/Cargo.toml
  - apps/desktop/src-tauri/tauri.conf.json
  - apps/desktop/src-tauri/src/lib.rs
  - apps/desktop/src-tauri/src/main.rs
  - apps/desktop/src-tauri/capabilities/default.json
  - apps/desktop/pnpm-lock.yaml
autonomous: true

must_haves:
  truths:
    - "pnpm install succeeds at workspace root"
    - "Tauri desktop app compiles (pnpm tauri build runs without error or at minimum cargo check passes in src-tauri)"
    - "Vite dev server starts for the frontend (pnpm --filter @aios/desktop dev starts without crashing)"
    - "Nix flake provides Node.js 22, pnpm, Rust toolchain"
  artifacts:
    - path: "package.json"
      provides: "Workspace root with scripts"
      contains: "@aios/monorepo"
    - path: "pnpm-workspace.yaml"
      provides: "Workspace package discovery"
      contains: "apps/*"
    - path: "flake.nix"
      provides: "Reproducible dev environment"
      contains: "nodejs_22"
    - path: "apps/desktop/src-tauri/src/lib.rs"
      provides: "Tauri entry point"
      contains: "pub fn run()"
    - path: "apps/desktop/vite.config.ts"
      provides: "Frontend build config with Tailwind v4"
      contains: "tailwindcss"
  key_links:
    - from: "apps/desktop/package.json"
      to: "pnpm-workspace.yaml"
      via: "workspace membership"
      pattern: "@aios/desktop"
    - from: "apps/desktop/vite.config.ts"
      to: "apps/desktop/src-tauri/tauri.conf.json"
      via: "Tauri dev server config"
      pattern: "1420"
---

<objective>
Scaffold the monorepo root and Tauri desktop app with React, Vite, Tailwind v4, and a Nix flake for the dev environment.

Purpose: Establish the foundational workspace structure and primary application package so subsequent plans can add backend and shared packages.
Output: Working pnpm workspace with a Tauri+React desktop app that compiles and a Nix flake for reproducible development.
</objective>

<execution_context>
@/Users/neosapien/.claude/get-shit-done/workflows/execute-plan.md
@/Users/neosapien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-setup/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create monorepo root and Nix flake</name>
  <files>
    package.json
    pnpm-workspace.yaml
    .gitignore
    flake.nix
    .envrc
  </files>
  <action>
Create the workspace root files:

1. **package.json** - Root workspace package:
   ```json
   {
     "name": "@aios/monorepo",
     "private": true,
     "scripts": {
       "dev": "pnpm --filter @aios/desktop dev",
       "build": "pnpm --filter @aios/desktop build",
       "dev:backend": "pnpm --filter @aios/backend dev",
       "lint": "eslint .",
       "typecheck": "tsc -b"
     },
     "engines": {
       "node": ">=22"
     }
   }
   ```

2. **pnpm-workspace.yaml**:
   ```yaml
   packages:
     - 'apps/*'
     - 'packages/*'
   ```

3. **.gitignore** - Extend existing with:
   - `node_modules/`, `dist/`, `target/` (Rust), `.turbo/`
   - `*.tsbuildinfo`
   - `.env`, `.env.local`
   - Keep existing `.planning` entries if any

4. **flake.nix** - Nix flake for dev environment:
   - Use nixpkgs-unstable
   - Support both `aarch64-darwin` and `x86_64-darwin` via flake-utils or eachDefaultSystem
   - Include: nodejs_22, pnpm, cargo, rustc, rust-analyzer, rustfmt, clippy, git
   - shellHook prints versions of Node, pnpm, Rust
   - Include `WEBKIT_DISABLE_COMPOSITING_MODE=1` env var if needed for Tauri on macOS

5. **.envrc** - `use flake` for direnv integration
  </action>
  <verify>
    - `cat package.json | grep "@aios/monorepo"` returns match
    - `cat pnpm-workspace.yaml | grep "apps/*"` returns match
    - `nix develop --command bash -c "node --version && pnpm --version && rustc --version"` succeeds (if nix available)
  </verify>
  <done>Workspace root exists with package.json, pnpm-workspace.yaml, .gitignore, and flake.nix. Nix shell provides Node 22, pnpm, and Rust.</done>
</task>

<task type="auto">
  <name>Task 2: Scaffold Tauri desktop app with React and Tailwind v4</name>
  <files>
    apps/desktop/package.json
    apps/desktop/index.html
    apps/desktop/vite.config.ts
    apps/desktop/tsconfig.json
    apps/desktop/tsconfig.node.json
    apps/desktop/src/main.tsx
    apps/desktop/src/App.tsx
    apps/desktop/src/index.css
    apps/desktop/src/vite-env.d.ts
    apps/desktop/src-tauri/Cargo.toml
    apps/desktop/src-tauri/tauri.conf.json
    apps/desktop/src-tauri/build.rs
    apps/desktop/src-tauri/src/lib.rs
    apps/desktop/src-tauri/src/main.rs
    apps/desktop/src-tauri/capabilities/default.json
    apps/desktop/src-tauri/icons/
    apps/desktop/pnpm-lock.yaml
  </files>
  <action>
Create the Tauri desktop app manually (do NOT use create-tauri-app as we need specific structure):

**Strategy:** Write all files directly rather than using scaffolding tools. This gives precise control over structure.

1. **apps/desktop/package.json**:
   ```json
   {
     "name": "@aios/desktop",
     "private": true,
     "version": "0.1.0",
     "type": "module",
     "scripts": {
       "dev": "vite",
       "build": "tsc -b && vite build",
       "preview": "vite preview",
       "tauri": "tauri"
     },
     "dependencies": {
       "@tauri-apps/api": "^2",
       "react": "^19.0.0",
       "react-dom": "^19.0.0"
     },
     "devDependencies": {
       "@tauri-apps/cli": "^2",
       "@tailwindcss/vite": "^4",
       "@types/react": "^19",
       "@types/react-dom": "^19",
       "@vitejs/plugin-react": "^4",
       "tailwindcss": "^4",
       "typescript": "^5.7",
       "vite": "^6"
     }
   }
   ```

2. **apps/desktop/vite.config.ts**:
   ```typescript
   import { defineConfig } from "vite";
   import react from "@vitejs/plugin-react";
   import tailwindcss from "@tailwindcss/vite";

   const host = process.env.TAURI_DEV_HOST;

   export default defineConfig(async () => ({
     plugins: [react(), tailwindcss()],
     clearScreen: false,
     server: {
       port: 1420,
       strictPort: true,
       host: host || false,
       hmr: host ? { protocol: "ws", host, port: 1421 } : undefined,
       watch: { ignored: ["**/src-tauri/**"] },
     },
   }));
   ```

3. **apps/desktop/index.html** - Standard Vite entry with `<div id="root">` and script src `./src/main.tsx`

4. **apps/desktop/tsconfig.json** - React 19 config with strict mode, target ES2020, jsx react-jsx, module ESNext, moduleResolution bundler. Include `src/`. References tsconfig.node.json.

5. **apps/desktop/tsconfig.node.json** - For vite.config.ts: composite true, module ESNext, moduleResolution bundler, include vite.config.ts.

6. **apps/desktop/src/main.tsx** - ReactDOM.createRoot rendering `<App />` into #root

7. **apps/desktop/src/App.tsx** - Minimal component with Tailwind classes showing "AIOS" heading and a test paragraph. Keep it simple - just prove React + Tailwind work.

8. **apps/desktop/src/index.css**:
   ```css
   @import "tailwindcss";
   ```

9. **apps/desktop/src/vite-env.d.ts** - `/// <reference types="vite/client" />`

10. **apps/desktop/src-tauri/Cargo.toml**:
    - Package name: `aios-desktop`, version 0.1.0, edition 2021
    - Dependencies: tauri (features: []), tauri-build (build dep), serde (features: ["derive"]), serde_json
    - Add `tauri-plugin-shell` dependency for shell plugin

11. **apps/desktop/src-tauri/build.rs** - Standard `tauri_build::build()`

12. **apps/desktop/src-tauri/tauri.conf.json**:
    - productName: "AIOS"
    - identifier: "com.aios.app"
    - build.devUrl: "http://localhost:1420"
    - build.frontendDist: "../dist"
    - build.beforeDevCommand: "pnpm dev"
    - build.beforeBuildCommand: "pnpm build"
    - app.windows: [{ title: "AIOS", width: 1200, height: 800 }]
    - plugins: {} (empty for now)

13. **apps/desktop/src-tauri/src/lib.rs**:
    ```rust
    #[cfg_attr(mobile, tauri::mobile_entry_point)]
    pub fn run() {
        tauri::Builder::default()
            .plugin(tauri_plugin_shell::init())
            .run(tauri::generate_context!())
            .expect("error while running tauri application");
    }
    ```

14. **apps/desktop/src-tauri/src/main.rs**:
    ```rust
    #![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]
    fn main() {
        aios_desktop::run()
    }
    ```

15. **apps/desktop/src-tauri/capabilities/default.json** - Default capability with core:default and shell:allow-open permissions.

16. **apps/desktop/pnpm-lock.yaml** - Create EMPTY file (workaround for Tauri CLI pnpm detection in monorepos, see research pitfall 1).

17. **Tauri icons** - Use `pnpm tauri icon` to generate default icons, OR create minimal placeholder icon. If the command isn't available yet, create the icons directory and note that icons can be generated later.

After creating all files, run from workspace root:
```bash
pnpm install
```
  </action>
  <verify>
    - `pnpm install` completes without errors
    - `pnpm --filter @aios/desktop exec vite --version` prints Vite version
    - `cd apps/desktop/src-tauri && cargo check` compiles without errors
    - `ls apps/desktop/src-tauri/src/lib.rs` exists
    - `grep "pub fn run" apps/desktop/src-tauri/src/lib.rs` returns match
  </verify>
  <done>Tauri desktop app exists at apps/desktop/ with React 19, Vite 6, Tailwind v4. pnpm install succeeds. Rust code compiles (cargo check passes). Empty pnpm-lock.yaml workaround in place.</done>
</task>

</tasks>

<verification>
Run these checks to verify the plan succeeded:

1. `pnpm install` - exits 0
2. `pnpm --filter @aios/desktop exec vite build` - frontend builds
3. `cd apps/desktop/src-tauri && cargo check` - Rust compiles
4. `nix develop --command node --version` - shows v22.x (if nix available)
5. Directory structure matches: apps/desktop/src/, apps/desktop/src-tauri/src/lib.rs
</verification>

<success_criteria>
- pnpm workspace resolves all packages
- Vite builds the React frontend without errors
- Cargo check passes for the Tauri Rust backend
- Nix flake provides correct toolchain versions
- Project structure matches the monorepo layout from research
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup/01-01-SUMMARY.md`
</output>
