---
phase: 03-node-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/index.ts
  - apps/backend/package.json
  - apps/backend/scripts/build-binaries.mjs
autonomous: true

must_haves:
  truths:
    - "Hono server starts on dynamic port (port 0) when PORT env var not set"
    - "Server logs BACKEND_PORT:{port} to stdout on startup"
    - "Server shuts down gracefully on SIGINT and SIGTERM"
    - "pkg build script produces platform binaries with correct Tauri target triple naming"
  artifacts:
    - path: "apps/backend/src/index.ts"
      provides: "Dynamic port Hono server with stdout port logging and graceful shutdown"
      contains: "BACKEND_PORT:"
    - path: "apps/backend/scripts/build-binaries.mjs"
      provides: "pkg build script with target triple renaming"
      contains: "aarch64-apple-darwin"
    - path: "apps/backend/package.json"
      provides: "pkg dependency and build:binary script"
      contains: "@yao-pkg/pkg"
  key_links:
    - from: "apps/backend/src/index.ts"
      to: "stdout"
      via: "console.log with BACKEND_PORT: prefix"
      pattern: "BACKEND_PORT:"
---

<objective>
Enhance the Hono backend server for sidecar operation: dynamic port allocation, structured stdout port logging for Tauri to parse, graceful shutdown handlers, and pkg binary build tooling.

Purpose: The backend must operate as a Tauri sidecar with OS-assigned ports and communicate its port via stdout. Binary compilation enables bundling with the desktop app.
Output: Production-ready backend server and build script for platform binaries.
</objective>

<execution_context>
@/Users/neosapien/.claude/get-shit-done/workflows/execute-plan.md
@/Users/neosapien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-node-backend/03-RESEARCH.md
@apps/backend/src/index.ts
@apps/backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Hono server for sidecar operation</name>
  <files>apps/backend/src/index.ts</files>
  <action>
Update apps/backend/src/index.ts to:

1. Use dynamic port: `const port = Number(process.env.PORT) || 0;` (change from hardcoded 3001)
2. In the serve callback, log `BACKEND_PORT:${info.port}` to stdout via `console.log` - this is the EXACT format Tauri will parse
3. Log human-readable startup message to stderr via `console.error` (so it doesn't interfere with stdout parsing)
4. Add `timestamp` and `uptime` fields to the /health response: `c.json({ status: 'ok', app: APP_NAME, timestamp: Date.now(), uptime: process.uptime() })`
5. Add graceful shutdown handlers for SIGINT and SIGTERM that call `server.close()` then `process.exit(0)`
6. Store the serve return value in a `server` variable so shutdown handlers can reference it

Keep the existing `@aios/shared` import and `AppType` export.

Reference the exact pattern from 03-RESEARCH.md Pattern 2.
  </action>
  <verify>
Run `cd /Users/neosapien/dev/aios && pnpm --filter @aios/backend build` - TypeScript compiles without errors.
Run `PORT=4444 pnpm --filter @aios/backend dev &` then check stdout contains "BACKEND_PORT:4444". Then `curl http://localhost:4444/health` returns JSON with status, timestamp, uptime. Kill the process.
  </verify>
  <done>Server starts on dynamic port, logs BACKEND_PORT:{port} to stdout, responds to /health with enriched JSON, shuts down gracefully on signals.</done>
</task>

<task type="auto">
  <name>Task 2: Add pkg build tooling for platform binaries</name>
  <files>apps/backend/package.json, apps/backend/scripts/build-binaries.mjs</files>
  <action>
1. Add `@yao-pkg/pkg` as a devDependency in apps/backend/package.json
2. Add script `"build:binary": "tsc && node scripts/build-binaries.mjs"` to package.json
3. Add `"pkg"` config to package.json:
```json
"pkg": {
  "assets": ["dist/**/*"],
  "targets": ["node18-macos-arm64"],
  "outputPath": "../desktop/src-tauri/binaries"
}
```
Note: Only target current platform (macOS ARM) for now. Cross-platform targets added when CI/CD is set up.

4. Create apps/backend/scripts/build-binaries.mjs:
```javascript
import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const outputDir = path.resolve(__dirname, '../../desktop/src-tauri/binaries');

const targets = [
  { pkg: 'node18-macos-arm64', suffix: 'aarch64-apple-darwin' },
];

fs.mkdirSync(outputDir, { recursive: true });

for (const { pkg, suffix } of targets) {
  console.log(`Building for ${pkg}...`);
  execSync(
    `npx pkg dist/index.js --target ${pkg} --output ${outputDir}/backend-${suffix}`,
    { stdio: 'inherit', cwd: path.resolve(__dirname, '..') }
  );
  fs.chmodSync(`${outputDir}/backend-${suffix}`, 0o755);
  console.log(`Created backend-${suffix}`);
}
```

This script builds the backend binary with the correct Tauri target triple naming convention (`backend-aarch64-apple-darwin`).
  </action>
  <verify>
Run `cd /Users/neosapien/dev/aios && pnpm --filter @aios/backend build:binary` - should compile TypeScript and produce `apps/desktop/src-tauri/binaries/backend-aarch64-apple-darwin`.
Verify the binary exists and is executable: `ls -la apps/desktop/src-tauri/binaries/backend-aarch64-apple-darwin`.
  </verify>
  <done>pkg devDependency added, build:binary script works, binary produced in correct location with Tauri target triple naming.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @aios/backend build` compiles without errors
2. Backend starts on dynamic port and logs BACKEND_PORT:{port} to stdout
3. /health endpoint returns JSON with status, timestamp, uptime
4. SIGTERM causes graceful shutdown
5. `pnpm --filter @aios/backend build:binary` produces platform binary
</verification>

<success_criteria>
Backend server is sidecar-ready: dynamic port, stdout port logging, graceful shutdown, and platform binary build tooling all functional.
</success_criteria>

<output>
After completion, create `.planning/phases/03-node-backend/03-01-SUMMARY.md`
</output>
