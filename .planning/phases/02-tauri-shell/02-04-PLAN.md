---
phase: 02-tauri-shell
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - apps/desktop/src-tauri/src/state.rs
  - apps/desktop/src-tauri/src/lib.rs
  - apps/desktop/src-tauri/capabilities/default.json
autonomous: false

must_haves:
  truths:
    - "All IPC commands (health, secrets, MCP) registered in single generate_handler!"
    - "AppState contains KeyringService and McpManager"
    - "MCP servers shut down cleanly on app exit"
    - "pnpm tauri build produces a working binary"
  artifacts:
    - path: "apps/desktop/src-tauri/src/lib.rs"
      provides: "Complete Tauri builder with all commands and plugins"
      contains: "generate_handler!"
    - path: "apps/desktop/src-tauri/src/state.rs"
      provides: "Full AppState with all services"
      contains: "McpManager"
  key_links:
    - from: "apps/desktop/src-tauri/src/lib.rs"
      to: "all command modules"
      via: "generate_handler! with all commands"
      pattern: "generate_handler!.*health_check.*get_secrets.*start_mcp_server"
---

<objective>
Wire all services together: integrate MCP manager into AppState, register all IPC commands, add shutdown hook for clean process termination, update capabilities, and verify production build.

Purpose: Combines the independently-built components (secrets, MCP, SQLite) into a cohesive app. Final integration and verification that the phase success criteria are met.
Output: Complete, buildable Tauri shell with all Phase 2 features working together.
</objective>

<execution_context>
@/Users/neosapien/.claude/get-shit-done/workflows/execute-plan.md
@/Users/neosapien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-tauri-shell/02-CONTEXT.md
@.planning/phases/02-tauri-shell/02-01-SUMMARY.md
@.planning/phases/02-tauri-shell/02-02-SUMMARY.md
@.planning/phases/02-tauri-shell/02-03-SUMMARY.md
@apps/desktop/src-tauri/src/lib.rs
@apps/desktop/src-tauri/src/state.rs
@apps/desktop/src-tauri/capabilities/default.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Final integration -- state, commands, shutdown hook, capabilities</name>
  <files>
    apps/desktop/src-tauri/src/state.rs
    apps/desktop/src-tauri/src/lib.rs
    apps/desktop/src-tauri/capabilities/default.json
  </files>
  <action>
    1. Update src/state.rs to include ALL service fields:
       - keyring: KeyringService (from plan 02)
       - mcp_manager: McpManager (from plan 03)
       - Wrap in Arc<Mutex<>> as needed for async command access

    2. Update src/lib.rs:
       - Initialize complete AppState in setup closure with both KeyringService and McpManager
       - Load MCP config from default path (app data dir), create empty if missing
       - Register ALL commands in single generate_handler!:
         health_check, get_secrets, get_secret, set_secret, delete_secret,
         start_mcp_server, stop_mcp_server, list_mcp_servers
       - Add on_window_event or app exit hook to call mcp_manager.stop_all() for clean shutdown
       - Ensure tauri-plugin-sql is registered with SQLite migrations

    3. Update capabilities/default.json with permissions for ALL commands:
       - Health, secrets, and MCP commands all need allow permissions

    4. Verify everything compiles: cargo build

    5. Run `pnpm tauri build` to verify production binary can be produced.
       - If build fails due to signing/notarization, that's expected on CI -- cargo build success is sufficient.
  </action>
  <verify>
    `cd /Users/neosapien/dev/aios/apps/desktop/src-tauri && cargo build` succeeds.
    `cd /Users/neosapien/dev/aios && pnpm tauri build` succeeds (or fails only on code signing which is acceptable).
  </verify>
  <done>All commands registered, AppState complete, shutdown hook cleans up MCP processes, production build succeeds.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Tauri shell with frameless window, system tray, secrets management (keyring), MCP server lifecycle management, and SQLite database initialization.</what-built>
  <how-to-verify>
    1. Run `pnpm tauri dev` from project root
    2. Verify: Frameless window opens, centered on screen
    3. Verify: No dock icon appears (tray only)
    4. Verify: System tray icon is visible with "Show" and "Quit" menu items
    5. Verify: Click "Quit" in tray menu exits the app
    6. Verify: SQLite database file exists in app data directory after launch
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. All IPC commands registered in single generate_handler!
3. App launches with frameless window and tray icon
4. SQLite database created with runs and messages tables
5. Clean shutdown kills MCP server processes
6. `pnpm tauri build` produces binary (ignoring code signing)
</verification>

<success_criteria>
- Phase 2 success criteria from roadmap all met:
  1. Tauri window opens with placeholder UI (frameless, centered)
  2. SQLite database initializes with runs and messages schema
  3. IPC commands callable from frontend (health_check proves pipeline)
  4. Production binary buildable
- Additional: secrets and MCP management infrastructure ready for future phases
</success_criteria>

<output>
After completion, create `.planning/phases/02-tauri-shell/02-04-SUMMARY.md`
</output>
