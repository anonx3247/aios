---
phase: 02-tauri-shell
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - apps/desktop/src-tauri/src/lib.rs
  - apps/desktop/src-tauri/capabilities/default.json
autonomous: false

must_haves:
  truths:
    - "All IPC commands (health, secrets, MCP) registered in single generate_handler!"
    - "AppState contains KeyringService and McpManager"
    - "MCP servers shut down cleanly on app exit"
    - "pnpm tauri build produces a working binary"
  artifacts:
    - path: "apps/desktop/src-tauri/src/lib.rs"
      provides: "Complete Tauri builder with all commands and plugins"
      contains: "generate_handler!"
    - path: "apps/desktop/src-tauri/src/state.rs"
      provides: "Full AppState with all services"
      contains: "McpManager"
  key_links:
    - from: "apps/desktop/src-tauri/src/lib.rs"
      to: "all command modules"
      via: "generate_handler! with all commands"
      pattern: "generate_handler!.*health_check.*get_secrets.*start_mcp_server"
---

<objective>
Final verification and production build. Validate all components are properly integrated and produce a buildable binary.

Purpose: Confirms all Phase 2 features work together and the app is buildable for production.
Output: Verified, buildable Tauri shell with all Phase 2 features.
</objective>

<execution_context>
@/Users/neosapien/.claude/get-shit-done/workflows/execute-plan.md
@/Users/neosapien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-tauri-shell/02-CONTEXT.md
@.planning/phases/02-tauri-shell/02-01-SUMMARY.md
@.planning/phases/02-tauri-shell/02-02-SUMMARY.md
@.planning/phases/02-tauri-shell/02-03-SUMMARY.md
@apps/desktop/src-tauri/src/lib.rs
@apps/desktop/src-tauri/src/state.rs
@apps/desktop/src-tauri/capabilities/default.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Production build verification and any final fixes</name>
  <files>
    apps/desktop/src-tauri/src/lib.rs
    apps/desktop/src-tauri/capabilities/default.json
  </files>
  <action>
    1. Run `cargo build` to verify all components compile together.

    2. Run `pnpm tauri build` to verify production binary can be produced.
       - If build fails due to signing/notarization, that's expected -- cargo build success is sufficient.

    3. If any compilation issues from integration of plans 02 and 03, fix them:
       - Ensure single generate_handler! with ALL commands
       - Ensure capabilities/default.json has permissions for ALL commands
       - Ensure AppState has both KeyringService and McpManager

    4. Verify shutdown hook exists for mcp_manager.stop_all().
  </action>
  <verify>
    `cd /Users/neosapien/dev/aios/apps/desktop/src-tauri && cargo build` succeeds.
    `cd /Users/neosapien/dev/aios && pnpm tauri build` succeeds (or fails only on code signing which is acceptable).
  </verify>
  <done>All commands registered, AppState complete, shutdown hook cleans up MCP processes, production build succeeds.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Tauri shell with frameless window, system tray, secrets management (keyring), MCP server lifecycle management, and SQLite database initialization.</what-built>
  <how-to-verify>
    1. Run `pnpm tauri dev` from project root
    2. Verify: Frameless window opens, centered on screen
    3. Verify: No dock icon appears (tray only)
    4. Verify: System tray icon is visible with "Show" and "Quit" menu items
    5. Verify: Click "Quit" in tray menu exits the app
    6. Verify: SQLite database file exists in app data directory after launch
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. All IPC commands registered in single generate_handler!
3. App launches with frameless window and tray icon
4. SQLite database created with runs and messages tables
5. Clean shutdown kills MCP server processes
6. `pnpm tauri build` produces binary (ignoring code signing)
</verification>

<success_criteria>
- Phase 2 success criteria from roadmap all met:
  1. Tauri window opens with placeholder UI (frameless, centered)
  2. SQLite database initializes with runs and messages schema
  3. IPC commands callable from frontend (health_check proves pipeline)
  4. Production binary buildable
- Additional: secrets and MCP management infrastructure ready for future phases
</success_criteria>

<output>
After completion, create `.planning/phases/02-tauri-shell/02-04-SUMMARY.md`
</output>
