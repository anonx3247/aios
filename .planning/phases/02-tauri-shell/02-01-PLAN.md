---
phase: 02-tauri-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src-tauri/Cargo.toml
  - apps/desktop/src-tauri/src/lib.rs
  - apps/desktop/src-tauri/src/main.rs
  - apps/desktop/src-tauri/src/types/mod.rs
  - apps/desktop/src-tauri/src/types/errors.rs
  - apps/desktop/src-tauri/src/state.rs
  - apps/desktop/src-tauri/src/commands/mod.rs
  - apps/desktop/src-tauri/src/commands/health.rs
  - apps/desktop/src-tauri/tauri.conf.json
  - apps/desktop/src-tauri/capabilities/default.json
autonomous: true

must_haves:
  truths:
    - "Tauri window opens as frameless, centered, Raycast-style"
    - "App appears in menu bar tray only, not in dock"
    - "Tray icon has Show and Quit menu items"
    - "A test IPC command (health check) is callable from frontend"
    - "Window hides on blur (click outside)"
  artifacts:
    - path: "apps/desktop/src-tauri/src/types/errors.rs"
      provides: "AppError enum with Serialize impl"
      contains: "impl serde::Serialize for AppError"
    - path: "apps/desktop/src-tauri/src/state.rs"
      provides: "AppState struct for Tauri managed state"
      contains: "pub struct AppState"
    - path: "apps/desktop/src-tauri/src/commands/health.rs"
      provides: "Health check IPC command"
      contains: "tauri::command"
    - path: "apps/desktop/src-tauri/src/lib.rs"
      provides: "Tauri builder with tray, state, commands, window setup"
      contains: "invoke_handler"
  key_links:
    - from: "apps/desktop/src-tauri/src/lib.rs"
      to: "commands::health::health_check"
      via: "generate_handler! macro"
      pattern: "generate_handler!"
    - from: "apps/desktop/src-tauri/capabilities/default.json"
      to: "IPC commands"
      via: "permissions array"
      pattern: "permissions"
---

<objective>
Set up the Rust backend foundation for the Tauri shell: project structure with commands/services/types modules, error types, application state, frameless window with tray-only activation, dismiss-on-blur, and a test IPC command.

Purpose: Establishes the Rust architecture that all subsequent plans build on (secrets, MCP, SQLite). Also delivers the launcher-style window behavior (frameless, centered, tray-only, dismiss-on-blur).
Output: Compilable Tauri app with frameless window, system tray, and working IPC health check command.
</objective>

<execution_context>
@/Users/neosapien/.claude/get-shit-done/workflows/execute-plan.md
@/Users/neosapien/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tauri-shell/02-CONTEXT.md
@.planning/phases/02-tauri-shell/02-RESEARCH.md
@apps/desktop/src-tauri/Cargo.toml
@apps/desktop/src-tauri/src/lib.rs
@apps/desktop/src-tauri/src/main.rs
@apps/desktop/src-tauri/tauri.conf.json
@apps/desktop/src-tauri/capabilities/default.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rust project structure, dependencies, error types, and state</name>
  <files>
    apps/desktop/src-tauri/Cargo.toml
    apps/desktop/src-tauri/src/types/mod.rs
    apps/desktop/src-tauri/src/types/errors.rs
    apps/desktop/src-tauri/src/state.rs
    apps/desktop/src-tauri/src/commands/mod.rs
    apps/desktop/src-tauri/src/commands/health.rs
  </files>
  <action>
    1. Update Cargo.toml to add dependencies:
       - keyring = "3" (needed by plan 02)
       - tokio = { version = "1", features = ["full"] }
       - thiserror = "1"
       - backoff = { version = "0.4", features = ["tokio"] }
       - serde_json is already present
       - tauri features: add "tray-icon" feature to tauri dependency
       - Add tauri-plugin-sql = { version = "2", features = ["sqlite"] }

    2. Create src/types/mod.rs exposing errors submodule.

    3. Create src/types/errors.rs with AppError enum:
       - Variants: Keyring(String), Process(String), NotFound(String), Io(String), Database(String)
       - Derive Debug, thiserror::Error
       - Manual serde::Serialize impl (serialize as string via Display)
       - From impls for keyring::Error, std::io::Error

    4. Create src/state.rs with AppState struct:
       - For now, just a placeholder struct (secrets and MCP fields added by plans 02/03)
       - Will be wrapped in Mutex when managed by Tauri

    5. Create src/commands/mod.rs exposing health submodule.

    6. Create src/commands/health.rs with:
       - `#[tauri::command] async fn health_check() -> Result<String, AppError>` returning "ok"
       - This validates the IPC pipeline works end-to-end

    Use snake_case for all command names per CONTEXT.md IPC conventions.
  </action>
  <verify>
    Run `cd /Users/neosapien/dev/aios/apps/desktop/src-tauri && cargo check` -- should compile without errors.
  </verify>
  <done>Module structure exists, AppError serializes, health_check command compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Frameless window, system tray, dismiss-on-blur, and Tauri builder wiring</name>
  <files>
    apps/desktop/src-tauri/src/lib.rs
    apps/desktop/src-tauri/src/main.rs
    apps/desktop/src-tauri/tauri.conf.json
    apps/desktop/src-tauri/capabilities/default.json
  </files>
  <action>
    1. Update tauri.conf.json:
       - Window: width 750, height 500, center true, decorations false, visible true, focus true, label "main"
       - These dimensions approximate a Raycast-style launcher

    2. Update capabilities/default.json:
       - Add permissions for: core:default, core:window:allow-center, core:window:allow-hide, core:window:allow-show, core:window:allow-set-focus
       - Add permission for the health_check command (will need to check Tauri 2 syntax -- custom commands use "allow-health-check" or similar pattern)

    3. Rewrite src/lib.rs:
       - Import modules: mod commands; mod types; mod state;
       - In setup closure:
         a. Set ActivationPolicy::Accessory on macOS (hides from dock)
         b. Create system tray with TrayIconBuilder: menu items "Show" and "Quit"
         c. On "Show" menu event: get main window, show + set_focus
         d. On "Quit" menu event: app.exit(0)
         e. On tray icon click: toggle window visibility
       - Register commands via invoke_handler: generate_handler![commands::health::health_check]
       - Keep tauri_plugin_shell
       - Add tauri-plugin-sql with SQLite migrations (empty migrations array for now -- plan 02 adds the actual schema)

    4. Ensure main.rs just calls the lib run() function (should already be correct).

    5. For dismiss-on-blur: This is best handled on the frontend side (window.onFocusChanged). Since the frontend is a separate package, add a comment in lib.rs noting that blur-dismiss is handled by the frontend in Phase 3. For now, Escape key can be handled via a Tauri command or the frontend later.

    IMPORTANT: Do NOT use multiple invoke_handler calls -- only one generate_handler! macro with ALL commands listed.
    IMPORTANT: Use .kill_on_drop(true) pattern when spawning any processes (not needed yet, but establish the convention in comments).
  </action>
  <verify>
    Run `cd /Users/neosapien/dev/aios/apps/desktop/src-tauri && cargo build` -- should compile successfully. Then run `cd /Users/neosapien/dev/aios && pnpm tauri dev` briefly to confirm the window opens frameless with tray icon visible. Kill with Ctrl+C after visual confirmation.
  </verify>
  <done>Frameless centered window opens, tray icon appears with Show/Quit menu, app does not appear in dock, cargo build succeeds.</done>
</task>

</tasks>

<verification>
1. `cargo check` passes in src-tauri directory
2. `cargo build` succeeds
3. `pnpm tauri dev` launches frameless window with tray icon
4. Tray menu shows "Show" and "Quit" items
5. App does not appear in macOS dock
</verification>

<success_criteria>
- Rust project has commands/, types/, state.rs module structure
- AppError enum with Serialize impl exists
- health_check IPC command registered and callable
- Window is frameless and centered
- System tray with Show/Quit menu works
- App uses ActivationPolicy::Accessory (no dock icon)
- cargo build succeeds without warnings on custom code
</success_criteria>

<output>
After completion, create `.planning/phases/02-tauri-shell/02-01-SUMMARY.md`
</output>
